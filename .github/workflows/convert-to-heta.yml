name: convert to L2V5

on:
  workflow_dispatch: {}
  push:
    branches: [ master, '*-result' ]

jobs:
  convert-to-heta:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Installations of heta-compiler from repository
        run: |
          npm i -g hetalang/heta-compiler
          heta -v

      - name: Download semantic cases of version 3.4.0
        run: |
          mkdir -p cases
          curl -L -o cases/semantic_tests.zip https://github.com/sbmlteam/sbml-test-suite/releases/download/3.4.0/semantic_tests.v3.4.0.zip
          unzip cases/semantic_tests.zip -d cases/
          
      - name: Create file structure
        run: |
          bash ./bash/make-summary.sh

      - name: Upload entire directory as artifact
        uses: actions/upload-artifact@v2
        with:
          name: result
          path: result/

  prepare-heta:
    runs-on: ubuntu-latest
    needs: convert-to-heta

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v2
        with:
          name: result

      - name: Create directory
        run: |
          bash ./bash/make-heta.sh
      
      - name: Upload entire directory as artifact
        uses: actions/upload-artifact@v2
        with:
          name: result
          path: result/

  commit-to-result:
    runs-on: ubuntu-latest
    needs: prepare-heta

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v2
        with:
          name: result

      - name: copy static
        run: |
          cp -r static/* result/

      - name: Commit changes to result branch
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: result # The branch the action should deploy to.
          FOLDER: result # The folder the action should deploy.
          CLEAN: true
